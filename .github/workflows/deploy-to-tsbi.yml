name: Build, Push & Deploy to TSBI
on:
  push:
    branches: [main, dev, staging]  # Add other branches as needed
  pull_request:
    branches: [main]

env:
  REGISTRY: registry.tsbi.fun
  IMAGE_NAME: ${{ github.event.repository.name }}
  SITE_ID: myapp  # Replace with your site ID from sites/myapp.yml

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine environment and domain
        id: env
        run: |
          BRANCH="${{ github.ref_name }}"
          REPO_NAME="${{ github.event.repository.name }}"
          if [[ "$BRANCH" == "main" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "DOMAIN=${REPO_NAME}.tsbi.fun" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "dev" ]]; then
            echo "ENVIRONMENT=development" >> $GITHUB_ENV
            echo "DOMAIN=dev-${REPO_NAME}.tsbi.fun" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "staging" ]]; then
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "DOMAIN=staging-${REPO_NAME}.tsbi.fun" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=develop" >> $GITHUB_ENV
            echo "DOMAIN=develop-${REPO_NAME}.tsbi.fun" >> $GITHUB_ENV
          fi

      - name: Build Docker images
        run: |
          # Create a short, DNS-compliant tag from the commit SHA
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          
          # Build backend image
          docker build -f backend/Dockerfile -t $REGISTRY/$IMAGE_NAME-backend:$SHORT_SHA ./backend
          docker build -f backend/Dockerfile -t $REGISTRY/$IMAGE_NAME-backend:latest ./backend
          docker tag $REGISTRY/$IMAGE_NAME-backend:$SHORT_SHA $REGISTRY/$IMAGE_NAME-backend:${{ github.sha }}
          
          # Build frontend image
          docker build -f frontend/Dockerfile -t $REGISTRY/$IMAGE_NAME-frontend:$SHORT_SHA ./frontend
          docker build -f frontend/Dockerfile -t $REGISTRY/$IMAGE_NAME-frontend:latest ./frontend
          docker tag $REGISTRY/$IMAGE_NAME-frontend:$SHORT_SHA $REGISTRY/$IMAGE_NAME-frontend:${{ github.sha }}

      - name: Login to private registry
        run: echo ${{ secrets.REGISTRY_PASSWORD }} | docker login $REGISTRY -u ${{ secrets.REGISTRY_USER }} --password-stdin

      - name: Push images to registry
        run: |
          # Push backend images
          docker push $REGISTRY/$IMAGE_NAME-backend:$SHORT_SHA
          docker push $REGISTRY/$IMAGE_NAME-backend:latest
          docker push $REGISTRY/$IMAGE_NAME-backend:${{ github.sha }}
          
          # Push frontend images
          docker push $REGISTRY/$IMAGE_NAME-frontend:$SHORT_SHA
          docker push $REGISTRY/$IMAGE_NAME-frontend:latest
          docker push $REGISTRY/$IMAGE_NAME-frontend:${{ github.sha }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.TSBI_HOST }} >> ~/.ssh/known_hosts

      - name: Debug SSH Key (Optional)
        run: |
          echo "Checking SSH key configuration..."
          if [ -z "${{ secrets.TSBI_SSH_KEY }}" ]; then
            echo "âŒ TSBI_SSH_KEY secret is not set!"
            echo "Please add TSBI_SSH_KEY to your GitHub repository secrets."
            exit 1
          else
            echo "âœ… TSBI_SSH_KEY secret is set"
            # Check if it starts with BEGIN (basic format check)
            if echo "${{ secrets.TSBI_SSH_KEY }}" | grep -q "BEGIN"; then
              echo "âœ… SSH key appears to be properly formatted"
            else
              echo "âš ï¸  SSH key format may be incorrect"
              echo "Make sure to copy the entire private key including BEGIN and END lines"
            fi
          fi

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TSBI_HOST }}
          username: ${{ secrets.TSBI_USER }}
          key: ${{ secrets.TSBI_SSH_KEY }}
          script: |
            # Debug: Show environment variables
            echo "ðŸ” Deployment Configuration:"
            echo "   Registry: ${{ env.REGISTRY }}"
            echo "   Image Name: ${{ env.IMAGE_NAME }}"
            echo "   Site ID: ${{ env.SITE_ID }}"
            echo "   Environment: ${{ env.ENVIRONMENT }}"
            echo "   Domain: ${{ env.DOMAIN }}"
            echo "   Image Tag: $(echo '${{ github.sha }}' | cut -c1-8)"
            echo "   Branch: ${{ github.ref_name }}"
            echo ""

            # Set environment variables explicitly
            export REGISTRY="${{ env.REGISTRY }}"
            export IMAGE_NAME="${{ env.IMAGE_NAME }}"
            export SITE_ID="${{ env.SITE_ID }}"
            export ENVIRONMENT="${{ env.ENVIRONMENT }}"
            export DOMAIN="${{ env.DOMAIN }}"
            # Compute short SHA from commit SHA
            export IMAGE_TAG=$(echo "${{ github.sha }}" | cut -c1-8)
            export BRANCH="${{ github.ref_name }}"
            export COMMIT="${{ github.sha }}"

            # Authenticate with Docker registry on VPS
            echo "ðŸ” Authenticating with Docker registry..."
            echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login $REGISTRY -u ${{ secrets.REGISTRY_USER }} --password-stdin

            if [ $? -ne 0 ]; then
              echo "âŒ Failed to authenticate with Docker registry"
              exit 1
            fi

            echo "âœ… Successfully authenticated with registry"

            # Create site configuration if it doesn't exist
            SITE_CONFIG="/data/ecosystem/sites/${SITE_ID}.yml"
            if [ ! -f "$SITE_CONFIG" ]; then
              echo "ðŸ“ Creating site configuration for ${SITE_ID}..."
              cat > "$SITE_CONFIG" << EOF
            id: ${SITE_ID}
            domain: ${DOMAIN}
            environment: ${ENVIRONMENT}
            image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
            ports:
              - "80:5000"
            environment_variables:
              - NODE_ENV=${ENVIRONMENT}
              - PORT=5000
            health_check:
              path: /api/health
              interval: 30s
              timeout: 10s
              retries: 3
            restart_policy: unless-stopped
            EOF
              echo "âœ… Site configuration created at ${SITE_CONFIG}"
              echo "ðŸ“‹ Configuration content:"
              cat "$SITE_CONFIG"
            else
              echo "â„¹ï¸  Site configuration already exists at ${SITE_CONFIG}"
              echo "ðŸ”„ Updating image reference..."
              # Update the image reference in existing config
              sed -i "s|image:.*|image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}|" "$SITE_CONFIG"
            fi

            # Deploy using the registry script
            cd /data/ecosystem
            FULL_IMAGE_REF="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
            echo "ðŸš€ Deploying image: ${FULL_IMAGE_REF}"
            echo "ðŸ“ Command: ./scripts/deploy-from-registry.sh ${SITE_ID} ${ENVIRONMENT} ${DOMAIN} ${FULL_IMAGE_REF} --branch ${BRANCH} --commit ${COMMIT}"

            # Deploy backend
            echo "ðŸš€ Deploying backend service..."
            ./scripts/deploy-from-registry.sh myapp-backend ${ENVIRONMENT} api.${DOMAIN} ${REGISTRY}/${IMAGE_NAME}-backend:${IMAGE_TAG} --branch ${BRANCH} --commit ${COMMIT}
            
            # Deploy frontend
            echo "ðŸš€ Deploying frontend service..."
            ./scripts/deploy-from-registry.sh myapp-frontend ${ENVIRONMENT} ${DOMAIN} ${REGISTRY}/${IMAGE_NAME}-frontend:${IMAGE_TAG} --branch ${BRANCH} --commit ${COMMIT}

            # Check deployment status
            if [ $? -eq 0 ]; then
              echo "âœ… Deployment completed successfully!"
              echo "ðŸŒ Your app should be available at: https://${DOMAIN}"
            else
              echo "âŒ Deployment failed!"
              exit 1
            fi

      - name: Notify on failure (optional)
        if: failure()
        run: echo "Deployment failed. Check logs."